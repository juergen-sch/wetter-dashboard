<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Weather-Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { font-family: Arial, sans-serif; background: #f0f0f0; margin: 0; padding: 0; }
.container { width: 95%; max-width: 1300px; margin: 20px auto; background: #fff; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
h1, h2 { color: #333; margin-top: 1em; }
select, button { padding: 6px 12px; font-size: 16px; margin: 10px 5px 20px 0; }

pre {
  background: #f7f7f7;
  padding: 10px;
  border-radius: 6px;
  white-space: pre-wrap;
  font-size: 14px;
}

.buttons button.button-active { background: #007BFF; color: white; }
</style>
</head>

<body>
<div class="container">

<div style="display:flex; justify-content:space-between; align-items:center;">
  <h1 style="margin:0;">Weather-Dashboard</h1>
  <div id="datetime"></div>
</div>

<label>Ort wählen:</label>
<select id="location">
  <option value="Gmunden">Gmunden</option>
  <option value="Linz">Linz</option>
  <option value="Wels">Wels</option>
  <option value="Salzburg">Salzburg</option>
  <option value="Zell">Zell am See</option>
  <option value="Regau">Regau</option>
</select>

<h2>✈️ METAR / TAF (Flugwetter)</h2>

<label>Flugplatz wählen:</label>
<select id="metarSelect">
  <option value="LOLU">LOLU – Gmunden</option>
  <option value="LOLS">LOLS – Schärding</option>
  <option value="LOLW">LOLW – Wels</option>
  <option value="LOWL">LOWL – Linz</option>
  <option value="LOWW">LOWW – Wien</option>
  <option value="LOWG">LOWG – Graz</option>
  <option value="LOWI">LOWI – Innsbruck</option>
</select>

<div id="metarSummary" style="margin:10px 0; font-weight:bold;">
  Lade METAR…
</div>

<pre id="metarRaw">Lade METAR…</pre>
<pre id="tafRaw">Lade TAF…</pre>

</div>

<script>
/* ===============================
   METAR / TAF via Cloudflare
================================ */

const WX_PROXY = "https://orange-sky-8e02.juergen-sch85.workers.dev";

async function loadWx(type, icao, mode) {
  const r = await fetch(`${WX_PROXY}?type=${type}&icao=${icao}&mode=${mode}`);
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}

function extractRaw(json) {
  const d0 = json?.data?.[0];
  if (!d0) return "";
  if (typeof d0 === "string") return d0;   // TAF
  return d0.raw_text || "";                // METAR
}

async function updateMetarTaf() {
  const icao = document.getElementById("metarSelect").value;

  try {
    const metarJson = await loadWx("metar", icao, "decoded");
    const m = metarJson?.data?.[0];

    const tafJson = await loadWx("taf", icao, "raw");

    document.getElementById("metarRaw").textContent =
      m?.raw_text || "(kein METAR)";

    document.getElementById("tafRaw").textContent =
      extractRaw(tafJson) || "(kein TAF)";

    const summary = [
      m?.wind ? `Wind ${m.wind.direction || "VRB"} ${m.wind.speed?.kts || ""}kt` : null,
      m?.visibility?.text ? `Sicht ${m.visibility.text}` : null,
      m?.pressure?.hg ? `QNH ${Math.round(m.pressure.hg * 33.8639)} hPa` : null
    ].filter(Boolean).join(" • ");

    document.getElementById("metarSummary").textContent = summary || "—";

  } catch (e) {
    document.getElementById("metarSummary").textContent = "Fehler beim Laden";
    document.getElementById("metarRaw").textContent = "";
    document.getElementById("tafRaw").textContent = e.toString();
  }
}

document.getElementById("metarSelect").addEventListener("change", updateMetarTaf);
updateMetarTaf();

/* ===============================
   Datum & Uhrzeit
================================ */

function updateClock() {
  const now = new Date();
  document.getElementById("datetime").textContent =
    now.toLocaleDateString("de-DE", { weekday:"long", year:"numeric", month:"long", day:"numeric" })
    + " – " +
    now.toLocaleTimeString("de-DE");
}
updateClock();
setInterval(updateClock, 1000);
</script>

</body>
</html>
